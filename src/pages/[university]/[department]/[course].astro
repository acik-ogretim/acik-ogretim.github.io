---
import QuizPlayer from "../../../components/QuizPlayer.astro";
import Layout from "../../../layouts/Layout.astro";
import { getCourses, getQuestions, getUniversities } from "../../../lib/api";

export async function getStaticPaths() {
  const universities = await getUniversities();
  const paths = [];

  for (const uni of universities) {
    const departments = uni.departments || [];
    for (const dept of departments) {
      const courses = await getCourses(uni.id, dept.id);
      for (const course of courses) {
        paths.push({
          params: {
            university: uni.id,
            department: dept.id,
            course: course.id,
          },
          props: { university: uni, department: dept, course },
        });
      }
    }
  }
  return paths;
}

import type { Course, Department, University } from "../../../lib/types";

interface Props {
  university: University;
  department: Department;
  course: Course;
}

const { university, department, course } = Astro.props;
const questions = await getQuestions(university.id, course.id);

// Group questions by unit
const units = [...new Set(questions.map((q) => q.unitNumber))].sort(
  (a, b) => a - b,
);
---

<Layout title={`${course.name} - ${department.name}`}>
  <div class="py-12">
    <div class="container-reading">
      <!-- Breadcrumbs -->
      <nav class="flex mb-8 text-sm text-muted-theme">
        <a href="/" class="breadcrumb-link">Ana Sayfa</a>
        <span class="mx-2">/</span>
        <a href={`/${university.id}`} class="breadcrumb-link"
          >{university.shortName}</a
        >
        <span class="mx-2">/</span>
        <a href={`/${university.id}/${department.id}`} class="breadcrumb-link"
          >{department.name}</a
        >
        <span class="mx-2">/</span>
        <span class="text-theme font-medium">{course.name}</span>
      </nav>

      <!-- Article Header -->
      <header class="mb-12">
        <div class="flex flex-wrap items-center gap-3 md:gap-4 mb-4">
          <span
            class="px-2.5 py-0.5 bg-primary-theme/10 text-primary-theme rounded-full text-xs font-medium border border-primary-theme/20"
          >
            {course.semester}. Dönem
          </span>
          <span class="text-muted-theme font-mono text-xs">{course.code}</span>
        </div>
        <h1 class="text-2xl md:text-4xl font-bold text-theme mb-2 md:mb-4">
          {course.name}
        </h1>
        <p class="text-lg md:text-xl text-muted-theme mb-6">
          Toplam {questions.length} soru bulundu.
        </p>

        <a
          href={`/${university.id}/${department.id}/${course.id}/materyaller`}
          class="btn-primary"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"
            ></path>
          </svg>
          Ders Materyalleri
        </a>

        <button
          onclick="window.print()"
          class="btn-primary bg-slate-100 hover:bg-slate-200 text-slate-700 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300 border-none shadow-none ml-2"
          title="Yazdır / PDF Kaydet"
        >
          <svg
            class="w-5 h-5"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"
            ></path>
          </svg>
          <span class="hidden sm:inline ml-2">Yazdır</span>
        </button>
      </header>

      <!-- Search Shortcut Hint -->
      <div class="mb-6 print:hidden">
        <button
          onclick="document.getElementById('toggleSearch')?.click()"
          class="inline-flex items-center gap-2 px-3 py-2 bg-primary-theme/10 hover:bg-primary-theme/20 border border-primary-theme/30 rounded-lg text-sm text-primary-theme transition-colors group"
        >
          <svg
            class="w-4 h-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          <span>Sorularda ara</span>
          <kbd
            class="px-2 py-1 bg-card-theme border border-theme rounded text-xs font-mono group-hover:border-primary-theme transition-colors"
          >
            Ctrl+K
          </kbd>
        </button>
      </div>

      <!-- Navigation (Sticky) -->
      <nav
        class="sticky top-[64px] z-30 -mx-4 px-4 py-3 bg-[var(--bg-color)]/95 backdrop-blur-md border-b border-theme mb-12 md:static md:bg-transparent md:border-none md:p-0 transition-colors print:hidden"
        aria-label="Ünite Navigasyonu"
        data-reader-ignore
      >
        <div
          class="flex overflow-x-auto gap-2 no-scrollbar pb-2 md:pb-0 md:flex-wrap"
        >
          <span
            class="shrink-0 flex items-center text-xs font-bold text-muted-theme uppercase tracking-wider md:hidden"
          >
            Üniteler:
          </span>
          {
            units.map((unit) => (
              <a href={`#unite-${unit}`} class="btn-unit-nav">
                Ü {unit}
              </a>
            ))
          }
        </div>
      </nav>

      <!-- Sections (Units) -->
      <article class="max-w-none">
        <h1 class="sr-only">{course.name} - Tüm Sorular</h1>
        {
          units.map((unit, idx) => {
            const unitQuestions = questions.filter(
              (q) => q.unitNumber === unit,
            );
            return (
              <div
                id={`unite-${unit}`}
                class={`mb-16 scroll-mt-24 ${idx > 0 ? "mt-24" : ""} unit-separator`}
                data-unit={unit}
              >
                <h2
                  class={`text-2xl font-bold text-teal-400 border-b border-teal-500/20 pb-2 mb-8`}
                >
                  Ünite {unit}
                </h2>

                {unitQuestions.map((q, qIdx) => (
                  <div
                    class="question-card"
                    id={`question-${unit}-${qIdx}`}
                    data-unit={unit}
                    data-testid="question-card"
                  >
                    <header class="mb-4">
                      <h3 class="text-[10px] md:text-xs font-mono text-muted-theme uppercase tracking-widest">
                        Soru {qIdx + 1}
                      </h3>
                    </header>

                    <div class="prose prose-invert max-w-none">
                      <div
                        class="question-text text-base md:text-lg text-theme mb-6 md:mb-8 leading-relaxed font-medium"
                        set:html={q.text}
                      />

                      <h4 class="sr-only">Seçenekler</h4>
                      <div class="space-y-3 mb-6">
                        {q.options.map((opt) => {
                          const isCorrect = opt.key === q.correctAnswer;
                          return (
                            <div
                              class={`option-item p-4 rounded-xl border-2 border-theme flex items-start gap-3 transition-all ${
                                isCorrect ? "correct-option" : ""
                              }`}
                              data-key={opt.key}
                              data-testid={`option-${opt.key}`}
                            >
                              <span class="option-key flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-lg border-2 border-theme text-sm font-bold transition-colors">
                                {opt.key}
                              </span>
                              <div
                                class="option-text flex-1 pt-0.5 leading-relaxed"
                                set:html={opt.text}
                              />
                              <div class="option-marker hidden">
                                {isCorrect ? "✅" : "❌"}
                              </div>
                            </div>
                          );
                        })}
                      </div>

                      {q.explanation && (
                        <div class="explanation-card explanation-box text-muted-theme text-sm leading-relaxed">
                          <strong class="text-primary-theme uppercase tracking-wider mr-2 mb-1 block">
                            Açıklama:
                          </strong>
                          <div set:html={q.explanation} />
                        </div>
                      )}

                      <div class="answer-meta-card answer-metadata-box correct-answer-line">
                        <p class="text-muted-theme text-sm leading-relaxed">
                          <strong class="text-primary-theme uppercase tracking-wider mr-2">
                            Doğru Cevap:
                          </strong>
                          <span class="font-bold">{q.correctAnswer}</span>
                        </p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            );
          })
        }
      </article>

      <div
        class="hidden print-footer mt-8 text-center border-t border-gray-300 pt-4 text-xs text-gray-500 break-inside-avoid"
      >
        <p class="font-medium text-black">
          Bu çalışma kağıdı <strong>Açık Öğretim Portal</strong> (<a
            href="https://acik-ogretim.github.io">acik-ogretim.github.io</a
          >) üzerinden ücretsiz oluşturulmuştur.
        </p>
        <p class="mt-1">
          Daha fazla ders notu, çıkmış sorular ve denemeler için web sitemizi
          ziyaret edin.
        </p>
        <p class="mt-2 text-[10px] text-gray-400">
          © {new Date().getFullYear()} Açık Öğretim Portal. Ticari amaçla satılamaz.
        </p>
      </div>
    </div>
  </div>

  <QuizPlayer />

  <!-- Floating Search Button -->
  <button
    id="toggleSearch"
    class="fixed bottom-6 right-6 w-14 h-14 bg-primary-theme text-white rounded-full shadow-2xl flex items-center justify-center z-50 hover:scale-110 active:scale-95 transition-all print:hidden"
    aria-label="Soru Ara"
  >
    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
    </svg>
  </button>

  <!-- Search Modal/Panel -->
  <div
    id="searchPanel"
    class="fixed inset-0 bg-black/0 pointer-events-none z-[60] flex items-end justify-center px-4 pb-24 print:hidden transition-colors duration-300"
  >
    <div
      id="searchInner"
      class="w-full max-w-2xl bg-card-theme border-2 border-primary-theme rounded-2xl shadow-2xl p-4 transform translate-y-full opacity-0 transition-all duration-300 relative z-10"
    >
      <div class="flex items-center gap-3">
        <input
          type="text"
          id="questionSearch"
          placeholder="Sorularda ara... (Örn: dom eleman) • Ctrl+K"
          class="flex-1 bg-transparent text-theme text-lg outline-none py-2"
        />
        <button id="closeSearch" class="p-2 text-muted-theme hover:text-theme">
          <svg
            class="w-6 h-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div id="searchCounter" class="text-xs text-muted-theme mt-2 font-medium">
      </div>
      <div id="searchResults" class="mt-3 hidden">
        <div class="text-xs font-semibold text-primary-theme mb-2">
          Sonuçlar:
        </div>
        <div id="unitResults" class="flex flex-wrap gap-2"></div>
      </div>
    </div>
  </div>

  <script>
    import { createFuse, normalizeTurkish } from "../../../lib/search";

    const toggleBtn = document.getElementById("toggleSearch");
    const searchPanel = document.getElementById("searchPanel");
    const searchInner = document.getElementById("searchInner");
    const searchInput = document.getElementById(
      "questionSearch",
    ) as HTMLInputElement;
    const closeBtn = document.getElementById("closeSearch");
    const counter = document.getElementById("searchCounter");
    const questionCards = Array.from(
      document.querySelectorAll(".question-card"),
    );
    const unitSections = document.querySelectorAll(".unit-separator");

    // Prepare Fuse Index for Questions
    const searchData = questionCards.map((card, index) => {
      const text = (card as HTMLElement).innerText;
      return {
        text: text,
        normalizedText: normalizeTurkish(text),
        id: index,
        element: card as HTMLElement,
      };
    });

    const fuse = createFuse(searchData, ["text", "normalizedText"], 0.4);

    function openSearch() {
      searchPanel?.classList.remove("pointer-events-none");
      searchPanel?.classList.remove("bg-black/0");
      searchPanel?.classList.add("bg-black/20");
      searchInner?.classList.remove("translate-y-full", "opacity-0");
      searchInput?.focus();
    }

    function closeSearch() {
      searchPanel?.classList.add("pointer-events-none");
      searchPanel?.classList.add("bg-black/0");
      searchPanel?.classList.remove("bg-black/20");
      searchInner?.classList.add("translate-y-full", "opacity-0");
      if (searchInput) searchInput.value = "";
      applySearch("");
    }

    function applySearch(query: string) {
      const q = query.trim().toLowerCase();
      let visibleCount = 0;
      const unitMatches = new Map<string, number>();

      // COMMAND LOGIC
      if (q.startsWith("/")) {
        const parts = q.split(" ");
        const cmd = parts[0];
        const arg = parts[1];

        questionCards.forEach((card) => {
          const unit = (card as HTMLElement).dataset.unit;
          const qIdx = questionCards.indexOf(card) + 1;
          const choices = (card as HTMLElement).querySelectorAll(
            ".option-item",
          );
          const correctKey = Array.from(choices)
            .find((c) => c.classList.contains("correct-option"))
            ?.getAttribute("data-key")
            ?.toLowerCase();

          let visible = false;
          if (cmd === "/u" || cmd === "/unite") visible = unit === arg;
          else if (cmd === "/q" || cmd === "/soru")
            visible = qIdx.toString() === arg;
          else if (cmd === "/correct" || cmd === "/dogru")
            visible = correctKey === arg;
          else visible = true;

          (card as HTMLElement).classList.toggle("hidden", !visible);
          if (visible) {
            visibleCount++;
            if (unit) unitMatches.set(unit, (unitMatches.get(unit) || 0) + 1);
          }
        });
      } else {
        // NORMAL SEARCH (FUSE)
        if (!q) {
          // Reset
          questionCards.forEach((card) => {
            (card as HTMLElement).classList.remove("hidden");
            visibleCount++;
            const unit = (card as HTMLElement).dataset.unit;
            if (unit) unitMatches.set(unit, (unitMatches.get(unit) || 0) + 1);
          });
        } else {
          const results = fuse.search(q);
          const foundIndices = new Set(results.map((r) => r.item.id));

          questionCards.forEach((card, index) => {
            const visible = foundIndices.has(index);
            (card as HTMLElement).classList.toggle("hidden", !visible);
            if (visible) {
              visibleCount++;
              const unit = (card as HTMLElement).dataset.unit;
              if (unit) unitMatches.set(unit, (unitMatches.get(unit) || 0) + 1);
            }
          });
        }
      }

      unitSections.forEach((section) => {
        const hasVisible =
          section.querySelectorAll(".question-card:not(.hidden)").length > 0;
        (section as HTMLElement).classList.toggle("hidden", !hasVisible);
      });

      const resultsDiv = document.getElementById("searchResults");
      const unitResultsDiv = document.getElementById("unitResults");

      if (counter) {
        if (!query) {
          counter.innerHTML =
            '<span class="opacity-50">İpucu: <b>/u 5</b> (Ünite 5), <b>/q 10</b> (Soru 10), <b>/correct A</b></span>';
          resultsDiv?.classList.add("hidden");
        } else {
          counter.innerHTML = `<b>${visibleCount}</b> soru bulundu`;

          if (visibleCount > 0 && unitMatches.size > 0) {
            resultsDiv?.classList.remove("hidden");
            if (unitResultsDiv) {
              unitResultsDiv.innerHTML = "";
              Array.from(unitMatches.entries())
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]))
                .forEach(([unit, count]) => {
                  const badge = document.createElement("button");
                  badge.className =
                    "px-2 py-1 bg-primary-theme/20 hover:bg-primary-theme/30 text-primary-theme rounded text-xs font-medium transition-colors";
                  badge.textContent = `Ünite ${unit} (${count})`;
                  badge.onclick = () => {
                    const unitEl = document.getElementById(`unite-${unit}`);
                    unitEl?.scrollIntoView({
                      behavior: "smooth",
                      block: "start",
                    });
                    closeSearch();
                  };
                  unitResultsDiv.appendChild(badge);
                });
            }
          } else {
            resultsDiv?.classList.add("hidden");
          }
        }
      }
    }

    toggleBtn?.addEventListener("click", openSearch);
    closeBtn?.addEventListener("click", closeSearch);

    // Close when clicking backdrop (outside search box)
    searchPanel?.addEventListener("click", (e) => {
      if (e.target === searchPanel) closeSearch();
    });

    searchInput?.addEventListener("input", (e) =>
      applySearch((e.target as HTMLInputElement).value),
    );

    // Initial help text
    applySearch("");

    // Shortcut: Ctrl/Cmd + K (like command palette)
    window.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault();
        openSearch();
      }
      if (e.key === "Escape") closeSearch();
    });
  </script>
</Layout>

{
  /* Inject print styles directly to avoid CSS Variable scope issues in @page context */
}
<style
  set:html={`
  @media print {
    @page {
      margin-top: 2cm;
      margin-bottom: 2cm;

      @top-left {
        content: "${university.shortName} - ${department.name} / ${course.semester}. Dönem";
        font-size: 8pt;
        color: #888;
        font-family: monospace;
        margin-top: 4mm;
      }
      @top-right {
        content: "${course.name}";
        font-size: 8pt;
        font-weight: bold;
        color: #000;
        margin-top: 4mm;
      }
      @bottom-left {
        content: "acik-ogretim.github.io";
        font-size: 8pt;
        color: #aaa;
        margin-bottom: 4mm;
      }
      @bottom-right {
        content: "© ${new Date().getFullYear()}";
        font-size: 8pt;
        color: #aaa;
        margin-bottom: 4mm;
      }
      @bottom-center {
        content: counter(page);
        font-size: 10pt;
        font-weight: bold;
        margin-bottom: 4mm;
      }
    }
  }
`}
></style>
