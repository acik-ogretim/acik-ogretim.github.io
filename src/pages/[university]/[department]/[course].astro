---
import Layout from "../../../layouts/Layout.astro";
import { getCourses, getQuestions, getUniversities } from "../../../lib/api";

export async function getStaticPaths() {
  const universities = await getUniversities();
  const paths = [];

  for (const uni of universities) {
    const departments = (uni as any).departments || [];
    for (const dept of departments) {
      const courses = await getCourses(uni.id, dept.id);
      for (const course of courses) {
        paths.push({
          params: {
            university: uni.id,
            department: dept.id,
            course: course.id,
          },
          props: { university: uni, department: dept, course },
        });
      }
    }
  }
  return paths;
}

const { university, department, course } = Astro.props;
const questions = await getQuestions(university.id, course.id);

// Group questions by unit
const units = [...new Set(questions.map((q) => q.unitNumber))].sort(
  (a, b) => a - b,
);
---

<Layout title={`${course.name} - ${department.name}`}>
  <div class="py-12">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Breadcrumbs -->
      <nav class="flex mb-8 text-sm text-muted-theme">
        <a href="/" class="hover:text-primary-theme transition-colors"
          >Ana Sayfa</a
        >
        <span class="mx-2">/</span>
        <a
          href={`/${university.id}`}
          class="hover:text-primary-theme transition-colors"
          >{university.shortName}</a
        >
        <span class="mx-2">/</span>
        <a
          href={`/${university.id}/${department.id}`}
          class="hover:text-primary-theme transition-colors"
          >{department.name}</a
        >
        <span class="mx-2">/</span>
        <span class="text-theme font-medium">{course.name}</span>
      </nav>

      <!-- Article Header -->
      <header class="mb-12">
        <div class="flex flex-wrap items-center gap-3 md:gap-4 mb-4">
          <span
            class="px-2.5 py-0.5 bg-primary-theme/10 text-primary-theme rounded-full text-xs font-medium border border-primary-theme/20"
          >
            {course.semester}. Dönem
          </span>
          <span class="text-muted-theme font-mono text-xs">{course.code}</span>
        </div>
        <h1 class="text-2xl md:text-4xl font-bold text-theme mb-2 md:mb-4">
          {course.name}
        </h1>
        <p class="text-lg md:text-xl text-muted-theme">
          Toplam {questions.length} soru bulundu.
        </p>
      </header>

      <!-- Navigation (Sticky) -->
      <nav
        class="sticky top-[64px] z-30 -mx-4 px-4 py-3 bg-[var(--bg-color)]/95 backdrop-blur-md border-b border-theme mb-12 md:static md:bg-transparent md:border-none md:p-0 transition-colors print:hidden"
        aria-label="Ünite Navigasyonu"
        data-reader-ignore
      >
        <div
          class="flex overflow-x-auto gap-2 no-scrollbar pb-2 md:pb-0 md:flex-wrap"
        >
          <span
            class="shrink-0 flex items-center text-xs font-bold text-muted-theme uppercase tracking-wider md:hidden"
          >
            Üniteler:
          </span>
          {
            units.map((unit) => (
              <a
                href={`#unite-${unit}`}
                class="shrink-0 px-3 py-1.5 bg-button-theme hover:bg-button-hover-theme rounded-lg text-xs text-muted-theme hover:text-theme transition-colors border border-theme flex items-center justify-center min-w-[3.5rem] md:text-sm md:px-4 md:py-2"
              >
                Ü {unit}
              </a>
            ))
          }
        </div>
      </nav>

      <!-- Sections (Units) -->
      <article class="max-w-none">
        <h1 class="sr-only">{course.name} - Tüm Sorular</h1>
        {
          units.map((unit, idx) => {
            const unitQuestions = questions.filter(
              (q) => q.unitNumber === unit,
            );
            return (
              <div
                id={`unite-${unit}`}
                class={`mb-16 scroll-mt-24 ${idx > 0 ? "mt-24" : ""}`}
              >
                <h2
                  class={`text-2xl font-bold text-teal-400 border-b border-teal-500/20 pb-2 mb-8`}
                >
                  Ünite {unit}
                </h2>

                {unitQuestions.map((q, qIdx) => (
                  <div
                    class="glass p-4 sm:p-6 md:p-8 rounded-2xl border border-theme break-inside-avoid mb-12 last:mb-0"
                    id={`question-${unit}-${qIdx}`}
                  >
                    <header class="mb-4">
                      <h3 class="text-[10px] md:text-xs font-mono text-muted-theme uppercase tracking-widest">
                        Soru {qIdx + 1}
                      </h3>
                    </header>

                    <div class="prose prose-invert max-w-none">
                      <p
                        class="text-base md:text-lg text-theme mb-6 md:mb-8 leading-relaxed font-medium"
                        set:html={q.text}
                      />

                      <h4 class="sr-only">Seçenekler</h4>
                      <ul class="list-none space-y-3 pl-0 mb-6">
                        {(
                          (Array.isArray(q.options)
                            ? q.options
                            : Object.entries(q.options || {}).map(
                                ([key, text]) => ({ key, text }),
                              )) as any[]
                        ).map((opt) => (
                          <li class="relative pl-0">
                            <div
                              class="flex items-start gap-3 md:gap-4 p-3 md:p-4 rounded-xl border transition-all"
                              style={
                                opt.key === q.correctAnswer
                                  ? "background-color: var(--correct-bg); border-color: var(--correct-border);"
                                  : "background-color: var(--button-bg); border-color: var(--border-color);"
                              }
                            >
                              {opt.key === q.correctAnswer && (
                                <meta content={opt.key} />
                              )}
                              <span
                                class="w-7 h-7 md:w-8 md:h-8 rounded-lg flex items-center justify-center font-bold text-xs md:text-sm shrink-0"
                                style={
                                  opt.key === q.correctAnswer
                                    ? "background-color: var(--correct-border); color: #fff;"
                                    : "background-color: var(--button-bg); color: var(--text-color-muted);"
                                }
                                aria-hidden="true"
                              >
                                {opt.key}
                              </span>
                              <span
                                class="pt-1 md:pt-1.5 text-sm md:text-base block"
                                style={
                                  opt.key === q.correctAnswer
                                    ? "color: var(--text-color); font-weight: bold;"
                                    : "color: var(--text-color-muted);"
                                }
                                set:html={opt.text}
                              />
                            </div>
                          </li>
                        ))}
                      </ul>

                      {q.explanation && (
                        <div class="mt-6 md:mt-8 p-4 md:p-6 bg-primary-theme/5 rounded-xl border border-primary-theme/20">
                          <p class="text-muted-theme text-sm leading-relaxed">
                            <strong class="text-primary-theme uppercase tracking-wider mr-2">
                              Açıklama:
                            </strong>
                            <span set:html={q.explanation} />
                          </p>
                        </div>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            );
          })
        }
      </article>
    </div>
  </div>
</Layout>
```
