---
import QuizPlayer from "../../../components/QuizPlayer.astro";
import Layout from "../../../layouts/Layout.astro";
import { getCourses, getQuestions, getUniversities } from "../../../lib/api";

export async function getStaticPaths() {
  const universities = await getUniversities();
  const paths = [];

  for (const uni of universities) {
    const departments = uni.departments || [];
    for (const dept of departments) {
      const courses = await getCourses(uni.id, dept.id);
      for (const course of courses) {
        paths.push({
          params: {
            university: uni.id,
            department: dept.id,
            course: course.id,
          },
          props: { university: uni, department: dept, course },
        });
      }
    }
  }
  return paths;
}

import type { Course, Department, University } from "../../../lib/types";

interface Props {
  university: University;
  department: Department;
  course: Course;
}

const { university, department, course } = Astro.props;
const questions = await getQuestions(university.id, course.id);

// Group questions by unit
const units = [...new Set(questions.map((q) => q.unitNumber))].sort(
  (a, b) => a - b,
);
---

<Layout title={`${course.name} - ${department.name}`}>
  <div class="py-12">
    <div class="container-reading">
      <!-- Breadcrumbs -->
      <nav class="flex mb-8 text-sm text-muted-theme">
        <a href="/" class="breadcrumb-link"
          >Ana Sayfa</a
        >
        <span class="mx-2">/</span>
        <a
          href={`/${university.id}`}
          class="breadcrumb-link"
          >{university.shortName}</a
        >
        <span class="mx-2">/</span>
        <a
          href={`/${university.id}/${department.id}`}
          class="breadcrumb-link"
          >{department.name}</a
        >
        <span class="mx-2">/</span>
        <span class="text-theme font-medium">{course.name}</span>
      </nav>

      <!-- Article Header -->
      <header class="mb-12">
        <div class="flex flex-wrap items-center gap-3 md:gap-4 mb-4">
          <span
            class="px-2.5 py-0.5 bg-primary-theme/10 text-primary-theme rounded-full text-xs font-medium border border-primary-theme/20"
          >
            {course.semester}. Dönem
          </span>
          <span class="text-muted-theme font-mono text-xs">{course.code}</span>
        </div>
        <h1 class="text-2xl md:text-4xl font-bold text-theme mb-2 md:mb-4">
          {course.name}
        </h1>
        <p class="text-lg md:text-xl text-muted-theme mb-6">
          Toplam {questions.length} soru bulundu.
        </p>

        <a href={`/${university.id}/${department.id}/${course.id}/materyaller`} class="btn-primary">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Ders Materyalleri
        </a>

        <button onclick="window.print()" class="btn-primary bg-slate-100 hover:bg-slate-200 text-slate-700 dark:bg-slate-800 dark:hover:bg-slate-700 dark:text-slate-300 border-none shadow-none ml-2" title="Yazdır / PDF Kaydet">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            <span class="hidden sm:inline ml-2">Yazdır</span>
        </button>
      </header>

      <!-- Navigation (Sticky) -->
      <nav
        class="sticky top-[64px] z-30 -mx-4 px-4 py-3 bg-[var(--bg-color)]/95 backdrop-blur-md border-b border-theme mb-12 md:static md:bg-transparent md:border-none md:p-0 transition-colors print:hidden"
        aria-label="Ünite Navigasyonu"
        data-reader-ignore
      >
        <div
          class="flex overflow-x-auto gap-2 no-scrollbar pb-2 md:pb-0 md:flex-wrap"
        >
          <span
            class="shrink-0 flex items-center text-xs font-bold text-muted-theme uppercase tracking-wider md:hidden"
          >
            Üniteler:
          </span>
          {
            units.map((unit) => (
              <a
                href={`#unite-${unit}`}
                class="btn-unit-nav"
              >
                Ü {unit}
              </a>
            ))
          }
        </div>
      </nav>

      <!-- Sections (Units) -->
      <article class="max-w-none">
        <h1 class="sr-only">{course.name} - Tüm Sorular</h1>
        {
          units.map((unit, idx) => {
            const unitQuestions = questions.filter(
              (q) => q.unitNumber === unit,
            );
            return (
              <div
                id={`unite-${unit}`}
                class={`mb-16 scroll-mt-24 ${idx > 0 ? "mt-24" : ""} unit-separator`}
                data-unit={unit}
              >
                <h2
                  class={`text-2xl font-bold text-teal-400 border-b border-teal-500/20 pb-2 mb-8`}
                >
                  Ünite {unit}
                </h2>

                {unitQuestions.map((q, qIdx) => (
                  <div
                    class="question-card"
                    id={`question-${unit}-${qIdx}`}
                    data-unit={unit}
                  >
                    <header class="mb-4">
                      <h3 class="text-[10px] md:text-xs font-mono text-muted-theme uppercase tracking-widest">
                        Soru {qIdx + 1}
                      </h3>
                    </header>

                    <div class="prose prose-invert max-w-none">
                      <p
                        class="text-base md:text-lg text-theme mb-6 md:mb-8 leading-relaxed font-medium"
                        set:html={q.text}
                      />

                      <h4 class="sr-only">Seçenekler</h4>
                      <ul class="list-none space-y-3 pl-0 mb-6">
                        {(
                          (Array.isArray(q.options)
                            ? q.options
                            : Object.entries(q.options || {}).map(
                                ([key, text]) => ({ key, text }),
                              )) as any[]
                        ).map((opt) => (
                          <li class="relative pl-0">
                            <div
                              class={`option-card option-item ${opt.key === q.correctAnswer ? "correct-option" : ""}`}
                              style={
                                opt.key === q.correctAnswer
                                  ? "background-color: var(--correct-bg); border-color: var(--correct-border);"
                                  : "background-color: var(--button-bg); border-color: var(--border-color);"
                              }
                            >
                              {opt.key === q.correctAnswer && (
                                <meta content={opt.key} />
                              )}
                              <span
                                class="option-key-badge option-key"
                                style={
                                  opt.key === q.correctAnswer
                                    ? "background-color: var(--correct-border); color: #fff;"
                                    : "background-color: var(--button-bg); color: var(--text-color-muted);"
                                }
                                aria-hidden="true"
                              >
                                {opt.key}
                              </span>
                              <span
                                class="option-text-content option-text"
                                style={
                                  opt.key === q.correctAnswer
                                    ? "color: var(--text-color); font-weight: bold;"
                                    : "color: var(--text-color-muted);"
                                }
                                set:html={opt.text}
                              />
                            </div>
                          </li>
                        ))}
                      </ul>

                      {q.explanation && (
                        <div class="explanation-card explanation-box">
                          <p class="text-muted-theme text-sm leading-relaxed">
                            <strong class="text-primary-theme uppercase tracking-wider mr-2">
                              Açıklama:
                            </strong>
                            <span set:html={q.explanation} />
                          </p>
                        </div>
                      )}

                      <!-- Correct Answer - Always rendered, control visibility via CSS -->
                      <div class="answer-meta-card answer-metadata-box correct-answer-line">
                          <p class="text-muted-theme text-sm leading-relaxed">
                            <strong class="text-primary-theme uppercase tracking-wider mr-2">
                              Doğru Cevap:
                            </strong>
                            <span class="font-bold">{q.correctAnswer}</span>
                          </p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            );
          })
        }
      </article>

      <div class="hidden print-footer mt-8 text-center border-t border-gray-300 pt-4 text-xs text-gray-500 break-inside-avoid">
        <p class="font-medium text-black">Bu çalışma kağıdı <strong>Açık Öğretim Portal</strong> (<a href="https://acik-ogretim.github.io">acik-ogretim.github.io</a>) üzerinden ücretsiz oluşturulmuştur.</p>
        <p class="mt-1">Daha fazla ders notu, çıkmış sorular ve denemeler için web sitemizi ziyaret edin.</p>
        <p class="mt-2 text-[10px] text-gray-400">© {new Date().getFullYear()} Açık Öğretim Portal. Ticari amaçla satılamaz.</p>
      </div>
    </div>
  </div>

  <QuizPlayer />
</Layout>

{/* Inject print styles directly to avoid CSS Variable scope issues in @page context */}
<style set:html={`
  @media print {
    @page {
      margin-top: 2cm;
      margin-bottom: 2cm;

      @top-left {
        content: "${university.shortName} - ${department.name} / ${course.semester}. Dönem";
        font-size: 8pt;
        color: #888;
        font-family: monospace;
        margin-top: 4mm;
      }
      @top-right {
        content: "${course.name}";
        font-size: 8pt;
        font-weight: bold;
        color: #000;
        margin-top: 4mm;
      }
      @bottom-left {
        content: "acik-ogretim.github.io";
        font-size: 8pt;
        color: #aaa;
        margin-bottom: 4mm;
      }
      @bottom-right {
        content: "© ${new Date().getFullYear()}";
        font-size: 8pt;
        color: #aaa;
        margin-bottom: 4mm;
      }
      @bottom-center {
        content: counter(page);
        font-size: 10pt;
        font-weight: bold;
        margin-bottom: 4mm;
      }
    }
  }
`} />
