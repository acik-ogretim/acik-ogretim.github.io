---
import Layout from "../layouts/Layout.astro";
import { getDepartments, getUniversities, getCourses } from "../lib/api";
import type { University, Course } from "../lib/types";
import fs from "node:fs";
import path from "node:path";

export async function getStaticPaths() {
  const universities = await getUniversities();
  return universities.map((uni) => ({
    params: { university: uni.id },
    props: { university: uni },
  }));
}

const { university } = Astro.props;
const allDepartments = await getDepartments(university.id);

// Check which departments have courses with questions
const COURSES_DIR = path.resolve(process.cwd(), "data/courses", university.id);
const QUESTIONS_DIR = path.resolve(
  process.cwd(),
  "data/questions",
  university.id,
);

function departmentHasQuestions(deptId: string): boolean {
  try {
    const coursesFile = path.join(COURSES_DIR, `${deptId}.json`);
    if (!fs.existsSync(coursesFile)) return false;

    const courses = JSON.parse(fs.readFileSync(coursesFile, "utf-8"));
    if (!Array.isArray(courses) || courses.length === 0) return false;

    // Check if at least one course has questions
    return courses.some((course: Course) => {
      const questionsFile = path.join(QUESTIONS_DIR, `${course.id}.json`);
      if (!fs.existsSync(questionsFile)) return false;
      try {
        const questions = JSON.parse(fs.readFileSync(questionsFile, "utf-8"));
        return Array.isArray(questions) && questions.length > 0;
      } catch {
        return false;
      }
    });
  } catch {
    return false;
  }
}

// Filter departments that have questions
const departmentsWithData = allDepartments.filter((dept) =>
  departmentHasQuestions(dept.id),
);

// Separate active and inactive departments
const activeDepartments = departmentsWithData.filter((d) => d.active !== false);
const inactiveDepartments = departmentsWithData.filter(
  (d) => d.active === false,
);

// Group active departments by degree
const degreeGroups: Record<
  string,
  { title: string; icon: string; departments: typeof activeDepartments }
> = {
  lisans: { title: "Lisans ProgramlarÄ±", icon: "ğŸ“", departments: [] },
  onlisans: { title: "Ã–n Lisans ProgramlarÄ±", icon: "ğŸ“˜", departments: [] },
  "lisans-tamamlama": {
    title: "Lisans Tamamlama",
    icon: "ğŸ“—",
    departments: [],
  },
  "uzem-lisans-tamamlama": {
    title: "UZEM Lisans Tamamlama",
    icon: "ğŸ¥",
    departments: [],
  },
  "tezsiz-yuksek-lisans": {
    title: "Tezsiz YÃ¼ksek Lisans",
    icon: "ğŸ–ï¸",
    departments: [],
  },
};

activeDepartments.forEach((dept) => {
  const degree = dept.degree || "lisans";
  if (degree === "uzem-lisans-tamamlama") {
    degreeGroups["uzem-lisans-tamamlama"].departments.push(dept);
  } else if (degree === "tezsiz-yuksek-lisans") {
    degreeGroups["tezsiz-yuksek-lisans"].departments.push(dept);
  } else if (
    degree === "lisans-tamamlama" ||
    dept.name?.toLowerCase().includes("(lt)")
  ) {
    degreeGroups["lisans-tamamlama"].departments.push(dept);
  } else if (degree === "onlisans") {
    degreeGroups["onlisans"].departments.push(dept);
  } else {
    degreeGroups["lisans"].departments.push(dept);
  }
});

// Sort each group alphabetically
Object.values(degreeGroups).forEach((group) => {
  group.departments.sort((a, b) => a.name.localeCompare(b.name, "tr"));
});
inactiveDepartments.sort((a, b) => a.name.localeCompare(b.name, "tr"));

const uniStyles: Record<string, { icon: string; gradient: string }> = {
  "anadolu-aof": { icon: "ğŸ“", gradient: "from-blue-600 to-blue-800" },
  "ataturk-aof": { icon: "ğŸ“•", gradient: "from-red-600 to-red-800" },
  auzef: { icon: "ğŸ“—", gradient: "from-purple-600 to-purple-800" },
};

const style = uniStyles[university.id] || {
  icon: "ğŸ“š",
  gradient: "from-slate-600 to-slate-800",
};
---

<Layout title={university.name}>
  <div class="py-8">
    <div class="container-base">
      <!-- Breadcrumbs -->
      <nav class="flex mb-6 text-sm text-muted-theme">
        <a href="/" class="hover:text-primary-theme transition-colors"
          >Ana Sayfa</a
        >
        <span class="mx-2">/</span>
        <span class="text-theme font-medium">{university.shortName}</span>
      </nav>

      <!-- Header Card -->
      <div
        class={`glass p-6 rounded-2xl relative overflow-hidden mb-8 border-theme`}
      >
        <div
          class={`absolute top-0 left-0 right-0 h-1 bg-gradient-to-r ${style.gradient}`}
        >
        </div>
        <div class="flex flex-col md:flex-row gap-6 items-center">
          <div
            class={`w-20 h-20 rounded-2xl flex items-center justify-center text-4xl bg-gradient-to-br ${style.gradient} shadow-lg text-white overflow-hidden`}
          >
            {
              university.logo ? (
                <img
                  src={university.logo}
                  alt={university.name}
                  class="w-full h-full object-contain p-4"
                />
              ) : (
                style.icon
              )
            }
          </div>
          <div class="text-center md:text-left flex-1">
            <h1 class="text-2xl md:text-3xl font-bold text-theme mb-1">
              {university.name}
            </h1>
            <p class="text-muted-theme">{university.faculty}</p>
          </div>
          <a
            href={university.website}
            target="_blank"
            class="py-2 px-4 text-sm bg-button-theme hover:bg-button-hover-theme text-theme border border-theme rounded-lg transition-colors"
          >
            ğŸŒ Web Sitesi
          </a>
        </div>
      </div>

      <!-- Search Box -->
      <div class="mb-8">
        <div class="relative mb-12">
          <div
            class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
          >
            <svg
              class="h-5 w-5 text-muted-theme"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
          <input
            type="text"
            id="deptSearch"
            placeholder="BÃ¶lÃ¼m ara... (Ã–rn: adalet, web tasarÄ±m, ilahiyat)"
            class="block w-full pl-10 pr-3 py-4 border border-theme rounded-2xl bg-card-theme text-theme placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-primary-theme focus:border-transparent transition-all shadow-sm text-lg"
          />
        </div>

        <!-- Favorites Section -->
        <div id="favorites-section" class="mb-8 hidden">
          <h2 class="text-xl font-bold text-theme flex items-center gap-2 mb-4">
            <span>â­</span> Favorilerim
            <span
              id="favorites-count"
              class="text-sm font-normal text-muted-theme"></span>
          </h2>
          <div
            id="favorites-grid"
            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3"
          >
          </div>
        </div>

        <div id="degreeGroups">
          <!-- Active Departments grouped by degree -->
          {
            Object.entries(degreeGroups).map(
              ([key, group]) =>
                group.departments.length > 0 && (
                  <div class="mb-8 degree-section">
                    <h2 class="text-xl font-bold text-theme flex items-center gap-2 mb-4">
                      <span>{group.icon}</span>
                      {group.title}
                      <span class="text-sm font-normal text-muted-theme">
                        ({group.departments.length})
                      </span>
                    </h2>

                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                      {group.departments.map((dept) => (
                        <div
                          class="dept-card group"
                          data-dept-id={dept.id}
                          data-dept-name={dept.name}
                          data-dept-icon={dept.icon || ""}
                          data-uni-id={university.id}
                          data-testid={`dept-card-${dept.id}`}
                        >
                          <div class="relative glass p-4 rounded-xl border border-theme bg-card-theme hover:border-primary-theme/50 transition-all">
                            <button
                              class="favorite-btn absolute top-2 right-2 w-6 h-6 rounded-full hover:bg-yellow-500/20 flex items-center justify-center transition-colors z-10"
                              title="Favorilere ekle"
                            >
                              <span class="fav-icon text-sm">â˜†</span>
                            </button>
                            <a
                              href={`/${university.id}/${dept.id}`}
                              class="flex items-center gap-3"
                            >
                              {dept.icon ? (
                                <img
                                  src={dept.icon}
                                  alt=""
                                  class="w-10 h-10 object-contain flex-shrink-0"
                                />
                              ) : (
                                <span class="text-2xl flex-shrink-0">ğŸ“‚</span>
                              )}
                              <span class="text-sm font-medium text-theme group-hover:text-primary-theme transition-colors line-clamp-2">
                                {dept.name}
                              </span>
                            </a>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                ),
            )
          }
        </div>

        <!-- Search Results Container -->
        <div
          id="searchResults"
          class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 mb-16 pb-8"
        >
        </div>

        <!-- Inactive Departments -->
        {
          inactiveDepartments.length > 0 && (
            <div id="inactiveDepartments" class="mb-8">
              <h2 class="text-lg font-bold text-muted-theme flex items-center gap-2 mb-4">
                <span class="opacity-50">ğŸ“¦</span>
                Pasif Programlar
                <span class="text-sm font-normal">
                  ({inactiveDepartments.length})
                </span>
              </h2>

              <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-2">
                {inactiveDepartments.map((dept) => (
                  <a
                    href={`/${university.id}/${dept.id}`}
                    class="group flex items-center gap-2 p-3 rounded-lg border border-theme/30 bg-card-theme/50 opacity-60 hover:opacity-100 transition-opacity"
                  >
                    {dept.icon ? (
                      <img
                        src={dept.icon}
                        alt=""
                        class="w-6 h-6 object-contain opacity-50"
                      />
                    ) : (
                      <span class="text-sm opacity-50">ğŸ“‚</span>
                    )}
                    <span class="text-xs text-muted-theme group-hover:text-theme transition-colors line-clamp-1">
                      {dept.name}
                    </span>
                  </a>
                ))}
              </div>
            </div>
          )
        }

        {
          departmentsWithData.length === 0 && (
            <div class="text-center py-12">
              <p class="text-muted-theme">HenÃ¼z yayÄ±nlanmÄ±ÅŸ soru bulunamadÄ±.</p>
            </div>
          )
        }

        <!-- No visible results message (for search) -->
        <div id="noResults" class="hidden py-12 text-center">
          <div class="text-4xl mb-4">ğŸ”</div>
          <h3 class="text-xl font-medium text-muted-theme">
            AradÄ±ÄŸÄ±nÄ±z kriterlere uygun bÃ¶lÃ¼m bulunamadÄ±.
          </h3>
        </div>
      </div>
      <script>
        import { createFuse, normalizeTurkish } from "../lib/search";

        const STORAGE_KEY = "favorite-departments";
        function getFavorites(): string[] {
          try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
          } catch {
            return [];
          }
        }

        function saveFavorites(favs: string[]) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));
        }

        function toggleFavorite(deptId: string) {
          const favs = getFavorites();
          const index = favs.indexOf(deptId);
          if (index > -1) favs.splice(index, 1);
          else favs.push(deptId);
          saveFavorites(favs);
          updateUI();
        }

        function updateUI() {
          // Global UI update for favorites across ALL cards (original + clones)
          const favs = getFavorites();
          const favSection = document.getElementById("favorites-section");
          const favGrid = document.getElementById("favorites-grid");
          const favCount = document.getElementById("favorites-count");

          // Update icons on ALL cards in DOM
          document.querySelectorAll(".dept-card").forEach((card) => {
            const deptId = card.getAttribute("data-dept-id");
            const icon = card.querySelector(".fav-icon");
            if (deptId && favs.includes(deptId)) {
              icon!.textContent = "â˜…";
              icon!.classList.add("text-yellow-500");
            } else {
              icon!.textContent = "â˜†";
              icon!.classList.remove("text-yellow-500");
            }
          });

          // Update favorites grid content
          if (favGrid && favSection && favCount) {
            const favCards = Array.from(
              document.querySelectorAll(".dept-card"),
            ).filter(
              (card) =>
                // Ideally we only clone from the main list so we don't clone clones
                !card.closest("#favorites-grid") &&
                !card.closest("#searchResults") &&
                favs.includes(card.getAttribute("data-dept-id") || ""),
            );

            // Use a Map or Set to deduplicate by ID since querySelectorAll finds all instances
            const uniqueFavIds = new Set();

            if (favs.length > 0) {
              favSection.classList.remove("hidden");
              // Count actual favorites for this page if filtering? Or just all favourites?
              // Let's count visible valid cards.
              // But favs array is global.
              // If we filter, we only show valid cards.

              // Clean grid
              favGrid.innerHTML = "";
              let count = 0;

              favs.forEach((favId) => {
                // Find a template card
                const original = document.querySelector(
                  `.dept-card[data-dept-id="${favId}"]:not(#favorites-grid .dept-card):not(#searchResults .dept-card)`,
                );
                if (original) {
                  const clone = original.cloneNode(true) as HTMLElement;
                  clone.classList.remove("hidden");
                  clone
                    .querySelector(".favorite-btn")
                    ?.addEventListener("click", (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      toggleFavorite(favId);
                    });
                  favGrid.appendChild(clone);
                  count++;
                }
              });

              favCount.textContent = `(${count})`;
              if (count === 0) favSection.classList.add("hidden");
            } else {
              favSection.classList.add("hidden");
            }
          }
        }

        document.addEventListener("DOMContentLoaded", () => {
          document.querySelectorAll(".favorite-btn").forEach((btn) => {
            btn.addEventListener("click", (e) => {
              e.preventDefault();
              e.stopPropagation();
              const deptId = btn
                .closest(".dept-card")
                ?.getAttribute("data-dept-id");
              if (deptId) toggleFavorite(deptId);
            });
          });
          updateUI();
        });

        // SEARCH LOGIC
        const searchInput = document.getElementById(
          "deptSearch",
        ) as HTMLInputElement;

        const deptCards = Array.from(
          document.querySelectorAll(
            ".dept-card:not(#favorites-section .dept-card)",
          ),
        ) as HTMLElement[];
        const degreeGroupsContainer = document.getElementById("degreeGroups");
        const inactiveDepartments = document.getElementById(
          "inactiveDepartments",
        ); // Selected newly added ID
        const searchResults = document.getElementById("searchResults");
        const noResults = document.getElementById("noResults");
        const favoritesSection = document.getElementById("favorites-section");

        // Prepare Fuse
        const searchData = deptCards.map((card, index) => ({
          name: card.dataset.deptName || "",
          normalizedName: normalizeTurkish(card.dataset.deptName || ""),
          id: index,
          element: card,
        }));

        const fuse = createFuse(searchData, ["name", "normalizedName"], 0.4);

        function applySearch(query: string) {
          const q = query.trim();

          if (!q) {
            // RESET
            degreeGroupsContainer?.classList.remove("hidden");
            inactiveDepartments?.classList.remove("hidden"); // Show inactive back
            searchResults?.classList.add("hidden");
            searchResults!.innerHTML = "";
            // Favorites should show if they exist
            if (getFavorites().length > 0)
              favoritesSection?.classList.remove("hidden");

            if (noResults) noResults.classList.add("hidden");
          } else {
            // SEARCH
            const results = fuse.search(normalizeTurkish(q));

            degreeGroupsContainer?.classList.add("hidden");
            inactiveDepartments?.classList.add("hidden"); // Hide inactive during search
            favoritesSection?.classList.add("hidden"); // Hide favorites during search to reduce noise

            searchResults?.classList.remove("hidden");
            searchResults!.innerHTML = "";

            if (results.length > 0) {
              results.forEach((result) => {
                const original = result.item.element;
                const clone = original.cloneNode(true) as HTMLElement;
                clone.classList.remove("hidden");

                // Re-bind events
                clone
                  .querySelector(".favorite-btn")
                  ?.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    original
                      .querySelector(".favorite-btn")
                      ?.dispatchEvent(new Event("click"));
                  });

                searchResults!.appendChild(clone);
              });
              if (noResults) noResults.classList.add("hidden");
            } else {
              if (noResults) noResults.classList.remove("hidden");
            }
          }
        }

        searchInput?.addEventListener("input", (e) =>
          applySearch((e.target as HTMLInputElement).value),
        );
      </script>
    </div>
  </div></Layout
>
