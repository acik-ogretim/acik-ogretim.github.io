---
import Layout from "../../../../layouts/Layout.astro";
import { getCourses, getUniversities } from "../../../../lib/api";
import type {
    Course,
    Department,
    University,
    Material,
    GroupedMaterials,
} from "../../../../lib/types";
import anadoluMaterialsData from "../../../../data/anadolu-materials.json";

export async function getStaticPaths() {
    const universities = await getUniversities();
    const paths = [];

    for (const uni of universities) {
        const departments = uni.departments || [];
        for (const dept of departments) {
            const courses = await getCourses(uni.id, dept.id);
            for (const course of courses) {
                paths.push({
                    params: {
                        university: uni.id,
                        department: dept.id,
                        course: course.id,
                    },
                    props: { university: uni, department: dept, course },
                });
            }
        }
    }
    return paths;
}

interface Props {
    university: University;
    department: Department;
    course: Course;
}

const { university, department, course } = Astro.props;
const automationId = course.automationId;

const isAtaAof = university.id === "ataturk-aof" && !!automationId;
const isAnadolu = university.id === "anadolu-aof";

// Helper to normalize strings (CLIENT/SERVER shared logic)
function normalize(str: string) {
    if (!str) return "";
    return str
        .replace(/ƒ∞/g, "i")
        .replace(/I/g, "i")
        .toLowerCase()
        .replace(/ƒ±/g, "i")
        .replace(/ƒü/g, "g")
        .replace(/√º/g, "u")
        .replace(/≈ü/g, "s")
        .replace(/√∂/g, "o")
        .replace(/√ß/g, "c")
        .replace(/[^a-z0-9]/g, "")
        .trim();
}

// Generate Material List
const materials: Material[] = [];

if (isAtaAof) {
    // 1. Short Summary
    materials.push({
        id: "summary",
        title: "üìù Kƒ±sa √ñzet",
        url: `https://oys.ataaof.edu.tr/kisaozetpdf/${automationId}-kisaozet.pdf`,
        type: "pdf",
    });

    // 2. Units
    const count = course.unitCount || 14;
    for (let i = 1; i <= count; i++) {
        materials.push({
            id: `unit-${i}`,
            title: `üìö √únite ${i}`,
            url: `https://oys.ataaof.edu.tr/file/${automationId}-${i}.pdf`,
            type: "pdf",
        });
    }
} else if (isAnadolu) {
    // 1. Imported External Materials (Live Recordings, HTML Books from JSON)
    // Key in JSON is now the portal's course ID
    // @ts-ignore
    const extraMaterials = anadoluMaterialsData[course.id] || [];

    extraMaterials.forEach((m: any) => {
        // Avoid duplicates if we already added it (simple check by url)
        if (!materials.some((exist) => exist.url === m.url)) {
            // Determine title icon based on type/category
            let icon = "üîó";
            if (m.type === "html") icon = "üåç";
            else if (m.category && m.category.includes("Canlƒ±")) icon = "üìπ";

            materials.push({
                id: `ext-${m.id}`,
                title: `${icon} ${m.title}`,
                url: m.url,
                type: m.type as any,
            });
        }
    });

    // 2. Algorithmic HTML Books (Fallback)
    if (course.code) {
        const code = course.code.toUpperCase();
        const count = course.unitCount || 8;
        for (let i = 1; i <= count; i++) {
            const url = `https://ets.anadolu.edu.tr/storage/nfs/html_books/${code}_INTERACTIVE/${code}-U${i}/`;
            // Only add if NOT already present (from JSON import)
            if (!materials.some((m) => m.url.includes(url))) {
                materials.push({
                    id: `unit-${i}`,
                    title: `üåç √únite ${i} (ƒ∞nteraktif)`,
                    url: url,
                    type: "html",
                });
            }
        }
    }
}

// --- Smart Grouping Logic ---
const groups: GroupedMaterials = {};

// Sort materials to ensure stability
materials.forEach((m) => {
    let category = "Genel";
    // Mapping naive categories to better headers
    if (
        m.type === "pdf" &&
        (m.id.toString().startsWith("unit") || m.id.toString() === "summary")
    ) {
        category = m.id === "summary" ? "√ñzetler" : "√únite PDFleri";
    } else if (m.type === "html") category = "ƒ∞nteraktif √úniteler";

    // Anadolu categories from JSON
    if (isAnadolu) {
        if (m.title.startsWith("√únite")) category = "√úniteler";
        else if (m.title.includes("Canlƒ± Ders"))
            category = "Canlƒ± Ders Kayƒ±tlarƒ±";
        else if (m.title.includes("√áƒ±kmƒ±≈ü Sƒ±nav")) category = "√áƒ±kmƒ±≈ü Sorular";
        else if (m.title.includes("√ñzet")) category = "√ñzetler";
    }

    // Initialize Category
    if (!groups[category]) groups[category] = { isTabbed: false, subGroups: {}, items: [] };

    // Sub-grouping logic (specifically for Live Courses by Year)
    let addedToSub = false;
    if (category === "Canlƒ± Ders Kayƒ±tlarƒ±") {
        const match = m.title.match(/(\d{4}-\d{4}\s+\w+)/);
        if (match) {
            const yearKey = match[1];
            if (!groups[category].subGroups[yearKey])
                groups[category].subGroups[yearKey] = [];
            groups[category].subGroups[yearKey].push(m);
            groups[category].isTabbed = true;
            addedToSub = true;
        }
    }

    if (!addedToSub) {
        groups[category].items.push(m);
    }
});

const defaultMaterial = materials.length > 0 ? materials[0] : null;

// Helper to determine initial iframe src
const getViewerUrl = (item: any) => {
    if (!item) return "";
    if (item.type === "html") return item.url;
    const convertToEmbed = (url: string) => {
        const youtubeRegex =
            /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
        const match = url.match(youtubeRegex);
        if (match && match[1]) {
            return `https://www.youtube.com/embed/${match[1]}?autoplay=0`;
        }
        return url;
    };
    if (item.url.includes("youtube.com") || item.url.includes("youtu.be")) {
        return convertToEmbed(item.url);
    }
    const isPdf =
        item.type === "pdf" || item.url.toLowerCase().endsWith(".pdf");
    if (isPdf) {
        return (
            "https://docs.google.com/viewer?url=" +
            encodeURIComponent(item.url) +
            "&embedded=true"
        );
    }
    return item.url;
};
---

<Layout title={`Materyaller: ${course.name}`}>
    <div class="py-12 min-h-screen">
        <div class="container-base h-full flex flex-col">
            <!-- Breadcrumbs -->
            <nav class="flex mb-8 text-sm text-muted-theme">
                <a
                    href={`/${university.id}/${department.id}/${course.id}`}
                    class="hover:text-primary-theme transition-colors"
                >
                    üîô Derse D√∂n
                </a>
                <span class="mx-2">/</span>
                <span class="text-theme font-medium">Ders Materyalleri</span>
            </nav>

            <div class="flex items-center justify-between mb-8">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-theme">
                        {course.name}
                    </h1>
                    <p class="text-muted-theme text-sm">
                        Resmi Ders Kaynaklarƒ±
                    </p>
                </div>
                <a
                    href={`/${university.id}/${department.id}/${course.id}`}
                    class="btn-secondary text-sm"
                >
                    Teslere D√∂n
                </a>
            </div>

            <div class="flex flex-col lg:flex-row gap-6 h-[800px]">
                <!-- Sidebar: Smart Group List -->
                <div
                    class="w-full lg:w-1/4 flex flex-col gap-2 overflow-y-auto glass p-4 rounded-xl border border-theme h-48 lg:h-full"
                >
                    {
                        Object.keys(groups).length > 0 ? (
                            Object.entries(groups).map(([catName, group]) => (
                                <details
                                    class="group/accordion mb-1"
                                    open={
                                        catName.includes("√únite") ||
                                        catName.includes("Canlƒ±")
                                    }
                                >
                                    <summary class="accordion-summary">
                                        {catName}
                                        <span class="group-open/accordion:rotate-180 transition-transform text-xs">
                                            ‚ñº
                                        </span>
                                    </summary>

                                    <div class="pl-2 flex flex-col gap-1 pb-2">
                                        {group.isTabbed && (
                                            <div class="flex flex-wrap gap-2 mb-2">
                                                {Object.keys(group.subGroups)
                                                    .sort()
                                                    .reverse()
                                                    .map((subKey, idx) => (
                                                        <button
                                                            class="tab-btn tab-btn-base"
                                                            data-category={
                                                                catName
                                                            }
                                                            data-tab={subKey}
                                                            data-active-tab={
                                                                idx === 0
                                                            }
                                                        >
                                                            {subKey}
                                                        </button>
                                                    ))}
                                            </div>
                                        )}

                                        {Object.entries(group.subGroups).map(
                                            ([subKey, subItems], idx) => (
                                                <div
                                                    class={`flex flex-col gap-1 tab-content ${idx !== 0 ? "hidden" : ""}`}
                                                    data-category={catName}
                                                    data-tab-content={subKey}
                                                >
                                                    {subItems.map((item) => (
                                                        <button
                                                            data-url={item.url}
                                                            data-type={
                                                                item.type
                                                            }
                                                            class="material-btn material-btn-base"
                                                        >
                                                            <span class="text-xs opacity-50 shrink-0">
                                                                {item.type ===
                                                                "html"
                                                                    ? "üåç"
                                                                    : item.type ===
                                                                        "pdf"
                                                                      ? "üìÑ"
                                                                      : "üîó"}
                                                            </span>
                                                            <span class="truncate">
                                                                {item.title
                                                                    .replace(
                                                                        subKey,
                                                                        "",
                                                                    )
                                                                    .replace(
                                                                        /^[_\W]+/,
                                                                        "",
                                                                    )}
                                                            </span>
                                                        </button>
                                                    ))}
                                                </div>
                                            ),
                                        )}

                                        {group.items.map((item) => (
                                            <button
                                                data-url={item.url}
                                                data-type={item.type}
                                                class="material-btn material-btn-base"
                                            >
                                                <span class="text-xs opacity-50 shrink-0">
                                                    {item.type === "html"
                                                        ? "üåç"
                                                        : item.type === "pdf"
                                                          ? "üìÑ"
                                                          : "üîó"}
                                                </span>
                                                <span class="truncate">
                                                    {item.title}
                                                </span>
                                            </button>
                                        ))}
                                    </div>
                                </details>
                            ))
                        ) : (
                            <div class="text-sm text-slate-500 italic p-2">
                                Bu ders i√ßin materyal bulunamadƒ±.
                            </div>
                        )
                    }
                </div>

                <!-- Viewer -->
                <div
                    class="w-full lg:w-3/4 flex-1 glass border border-theme rounded-xl overflow-hidden relative flex flex-col"
                >
                    {
                        defaultMaterial ? (
                            <>
                                <div class="bg-slate-900 px-4 py-2 border-b border-theme flex justify-between items-center shrink-0">
                                    <span
                                        id="viewer-title"
                                        class="text-xs font-bold text-teal-400 truncate pr-4"
                                    >
                                        {defaultMaterial.title}
                                    </span>
                                    <a
                                        id="download-link"
                                        href={defaultMaterial.url}
                                        target="_blank"
                                        class="text-xs text-blue-400 hover:text-blue-300 flex items-center gap-1 shrink-0"
                                    >
                                        {defaultMaterial.type === "html"
                                            ? "üîó Yeni Sekmede A√ß"
                                            : "‚¨áÔ∏è ƒ∞ndir"}
                                    </a>
                                </div>

                                <iframe
                                    id="pdf-viewer"
                                    src={getViewerUrl(defaultMaterial)}
                                    class="w-full h-full border-0 bg-white"
                                    title="Materyal √ñnizleme"
                                />

                                <div
                                    id="loader"
                                    class="absolute inset-0 bg-slate-900 flex flex-col items-center justify-center z-10 hidden"
                                >
                                    <div class="w-8 h-8 border-2 border-teal-500 border-t-transparent rounded-full animate-spin mb-2" />
                                    <span class="text-xs text-slate-400">
                                        Y√ºkleniyor...
                                    </span>
                                </div>
                            </>
                        ) : (
                            <div class="w-full h-full flex flex-col items-center justify-center p-12 text-center text-muted-theme">
                                <div class="text-5xl mb-4">üöß</div>
                                <p>G√∂r√ºnt√ºlenecek materyal yok.</p>
                            </div>
                        )
                    }
                </div>
            </div>
        </div>
    </div>
</Layout>

<script>
    const viewer = document.getElementById("pdf-viewer") as HTMLIFrameElement;
    const viewerTitle = document.getElementById("viewer-title");
    const downloadLink = document.getElementById(
        "download-link",
    ) as HTMLAnchorElement;
    const loader = document.getElementById("loader");

    document.querySelectorAll(".material-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".material-btn").forEach((b) => {
                b.classList.remove("is-active");
            });
            btn.classList.add("is-active");

            const url = btn.getAttribute("data-url");
            const type = btn.getAttribute("data-type");
            if (!url || !viewer) return;

            if (viewerTitle)
                viewerTitle.textContent = btn.textContent?.trim() || "";
            if (downloadLink) {
                downloadLink.href = url;
                downloadLink.textContent =
                    type === "html" ? "üîó Yeni Sekmede A√ß" : "‚¨áÔ∏è ƒ∞ndir";
            }
            if (loader) loader.classList.remove("hidden");

            const isPdf = type === "pdf" || url.toLowerCase().endsWith(".pdf");
            let finalSrc = url;

            const convertToEmbed = (u: string) => {
                const youtubeRegex =
                    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = u.match(youtubeRegex);
                if (match && match[1]) {
                    return `https://www.youtube.com/embed/${match[1]}?autoplay=0`;
                }
                return u;
            };

            // Re-implementing logic correctly
            if (isPdf) {
                finalSrc = `https://docs.google.com/viewer?url=${encodeURIComponent(url)}&embedded=true`;
            } else if (
                url.includes("youtube.com") ||
                url.includes("youtu.be")
            ) {
                const ytMatch = url.match(
                    /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/,
                );
                if (ytMatch && ytMatch[1])
                    finalSrc = `https://www.youtube.com/embed/${ytMatch[1]}?autoplay=0`;
            }

            setTimeout(() => {
                viewer.src = finalSrc;
                viewer.onload = () => {
                    if (loader) loader.classList.add("hidden");
                };
                setTimeout(() => {
                    if (loader) loader.classList.add("hidden");
                }, 2000);
            }, 300);
        });
    });

    document.querySelectorAll(".tab-btn").forEach((tab) => {
        tab.addEventListener("click", () => {
            const category = tab.getAttribute("data-category");
            const targetKey = tab.getAttribute("data-tab");
            document
                .querySelectorAll(`.tab-btn[data-category="${category}"]`)
                .forEach((t) => {
                    t.classList.remove("is-active");
                });
            tab.classList.add("is-active");
            document
                .querySelectorAll(`.tab-content[data-category="${category}"]`)
                .forEach((content) => {
                    if (
                        content.getAttribute("data-tab-content") === targetKey
                    ) {
                        content.classList.remove("hidden");
                    } else {
                        content.classList.add("hidden");
                    }
                });
        });
    });

    document
        .querySelectorAll('.tab-btn[data-active-tab="true"]')
        .forEach((t) => {
            t.classList.add("is-active");
        });
</script>
